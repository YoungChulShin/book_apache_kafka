## 4.4 프로듀서 주요옵션
bootstrap.servers
- 카프카 클러스터에 처음 연결을 하기 위한 호스트와 포트 정보로 구성된 리스트 정보를 나타낸다
- 예: peter-kafka001:9092,peter-kafka002:9092,peter-kafka003:9092
- 호스트 하나만 입력해도 가능하지만, 해당 호스트가 장애가 발생할 경우 접속이 불가하기 때문에 전체 리스트를 입력하는 것을 추천

acks
- 프로듀서가 카프카 토픽의 리더에게 메시지를 보낸 후 요청을 완료하기 전에 ack의 수
- acks=0
   - 프로듀서는 서버로부터 어떠한 ack도 기다리지 않는다
   - 메시지가 손실될 수 있지만, 프로듀서가 ack에 대한 응답을 기다리지 않기 때문에 빠르게 메시지를 보낼 수 있다
- acks=1
   - 리더는 데이터를 기록하지만, 모든 팔로워는 확인하지 않는다
   - 일부 데이터 손실이 발생할 수 있다(=팔로워가 리더의 데이터를 가져가는 시점에서)
- acks=all (또는 -1)
   - 리더가 팔로워로부터 데이터에 대한 ack를 기다린다
   - 데이터의 무손실에 대해 가장 강력하게 보장한다

buffer.memory
- 프로듀서가 카프카 서버로 데이터를 보내기 위해 잠시 대기할 수 있는 전체 메모리 바이트

compression.type
- 프로듀서가 데이터를 압축해서 보내는 것
- 옵션: none, gzip, snappy, lz4 

retries
- 일시적인 오류로 인해 전송에 실패한 데이터를 다시 보내는 횟수

batch.size
- 성능 측면에서의 향상을 위해서 프로듀서는 같은 파티션으로 보내는 여러 데이터를 배치로 보내려고 시도한다
- 이 옵션으로 배치 사이즈의 조정이 가능하다

linger.ms
- 배치 사이즈에 도달하지 못한 상태에서 linger.ms 제한 시간에 도달했을 때 메시지를 전송한다

max.request.size
- 프로듀서가 보낼 수 있는 최대 메시지 바이트 사이즈. 기본은 1MB

## 4.5 메시지 전송 방법
### 메시지 손실 가능성이 높지만 빠른 전송이 필요할 경우
설명
- 메시지를 전송할 때 프로듀서는 카프카 서버의 응답을 기다리지 않고 메시지를 보낼 준비가 되면 바로 보낸다. 따라서 빠르게 메시지 전달이 가능하지만, 손실이 발생할 수 있다
- 옵션에서 acks를 0으로 설정하면 된다
- 프로듀서의 acks=0 메시지 전송 방법
   ![4-3](/Ch4/Images/4-2.jpg)

### 메시지 손실 가능성ㅇ이 적고 적당한 속도의 전송이 필요한 경우
설명
- 메시지 손실 가능성이 적고, 적당한 속도의 전송이 필요한 경우
- 프로듀서가 카프카로 메시지를 보낸 후에, 보낸 메시지에 대해서 카프카가 잘 받았는지 확인을 한다. 이 확인 과정때문에 시간이 조금 더 늘어난다. 
- 옵션에서 acks를 1로 설정하면 된다

과정
1. 프로듀서가 메시지를 보낸다
2. 리더가 메시지를 받은 후 저장한다
3. 리더가 프로듀서에게 메시지를 받았다고 acks를 보낸다 (=여기까지가 동기화 과정)
4. 팔로워들은 리더를 주기적으로 바라보고 있다가 리더에게 새로운 메시지가 있는 것을 확인하고 팔로워들도 저장한다
   ![4-4](/Ch4/Images/4-4.jpg)

메시지 손실 발생 케이스
- 리더에게 장애가 발생했을 때 메시지 손실이 발생할 수 있다
- 리더에게 장애가 발생하면 팔로워 중에서 새로운 리더를 선출하게 되는데, 이 과정에서 팔로워가 프로듀서의 새로운 메시지를 모두 동기화하지 않은 상태라면 메시지가 손실될 수 있다

### 전송 속도는 느리지만 메시지 손실이 없어야 하는 경우
설명
- acks=1 보다 더 강력한 acks=all 옵션에 대한 동작
- 리더가 메시지를 받았는지 뿐 아니라, 팔로워까지 메시지를 받았는지 확인하는 동작
- 속도 측면에서 본다면 느리지만, 메시지 손실을 허용하지 않고자 할 때 사요하는 옵션이다

브로커의 min.insync.replicas 옵션
- 브로커의 동기화에서 최소한의 숫자를 설정하는 값
- 1개의 리더와 2개의 팔로워가 있다고 할 때
   - 1부터 시작하는데, 1은 리더의 동기화를 의미하기 때문에 ack=1과 같이 동작한다
   - 2는 팔로워 한개만 동기화가 되면 프로듀서로 acks를 전달할 수 있다
   - 3은 2개의 팔로워가 모두 동기화 되어야지 리더가 프로듀서로 acks를 응답한다
      ![4-9](/Ch4/Images/4-4.jpg)
      - 이 경우 1개의 팔로워에 문제가 발생하면 시스템에 문제가 발생할 수 있다
- 그래서 all로 설정하는 경우, min.insync.replicas를 2로 설정하고, 토픽의 리플리케이션 팩터를 3으로 설정하기를 권장한다

